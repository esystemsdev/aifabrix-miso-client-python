---
name: Fix and Improve Code - Services Authorization v2
overview: Extract duplicated application context methods from RoleService and PermissionService into a shared mixin class to reduce code duplication and improve maintainability.
todos:
  - id: create-mixin
    content: Create ApplicationContextMixin class with shared methods
    status: completed
  - id: update-role-service
    content: Update RoleService to use ApplicationContextMixin
    status: completed
  - id: update-permission-service
    content: Update PermissionService to use ApplicationContextMixin
    status: completed
  - id: run-tests
    content: Run tests to verify no regressions
    status: completed
isProject: false
---

# Fix and Improve Code - Services Authorization v2

## Overview

Extract duplicated application context methods from `RoleService` and `PermissionService` into a shared mixin class.

## Rules and Standards

This plan must comply with:
- **[Code Style - Code Reuse]** - No code duplication, use reusable utilities
- **[Code Size Guidelines]** - Files ≤500 lines, methods ≤20-30 lines
- **[Testing Conventions]** - Test both success and error paths

## Issues Identified

### Code Duplication

Both `RoleService` and `PermissionService` contain identical implementations of:

1. `_get_app_context_service()` - Creates/gets ApplicationContextService instance
2. `_get_environment_from_context()` - Extracts environment from cached context

**Duplicated Code (26 lines in each file):**

```python
def _get_app_context_service(self) -> ApplicationContextService:
    """Get or create application context service."""
    if self._app_context_service is None:
        internal_client = self.http_client._internal_client
        self._app_context_service = ApplicationContextService(internal_client)
    return self._app_context_service

def _get_environment_from_context(self) -> Optional[str]:
    """Get environment from application context (synchronous, uses cached value)."""
    try:
        app_context_service = self._get_app_context_service()
        if app_context_service._cached_context is not None:
            env = app_context_service._cached_context.environment
            return env if env and env != "unknown" else None
        return None
    except Exception:
        return None
```

## Implementation

### Solution: Create ApplicationContextMixin

Create a mixin class that both services can inherit from:

**File: `miso_client/services/authorization_mixin.py`**

```python
"""
Authorization mixin providing shared application context functionality.

This mixin provides common methods for role and permission services
to access application context for environment/application detection.
"""

from typing import TYPE_CHECKING, Optional

if TYPE_CHECKING:
    from ..services.application_context import ApplicationContextService
    from ..utils.http_client import HttpClient


class ApplicationContextMixin:
    """Mixin providing application context access for authorization services."""
    
    # Type hints for attributes that must be set by implementing class
    http_client: "HttpClient"
    _app_context_service: Optional["ApplicationContextService"]
    
    def _get_app_context_service(self) -> "ApplicationContextService":
        """Get or create application context service."""
        from ..services.application_context import ApplicationContextService
        
        if self._app_context_service is None:
            internal_client = self.http_client._internal_client
            self._app_context_service = ApplicationContextService(internal_client)
        return self._app_context_service

    def _get_environment_from_context(self) -> Optional[str]:
        """
        Get environment from application context (synchronous, uses cached value).

        Returns:
            Environment string if found, None otherwise
        """
        try:
            app_context_service = self._get_app_context_service()
            if app_context_service._cached_context is not None:
                env = app_context_service._cached_context.environment
                return env if env and env != "unknown" else None
            return None
        except Exception:
            return None
```

### Update RoleService

Remove duplicated methods and use mixin:

```python
from ..services.authorization_mixin import ApplicationContextMixin

class RoleService(ApplicationContextMixin):
    # Remove _get_app_context_service and _get_environment_from_context methods
    # Keep all other methods unchanged
```

### Update PermissionService

Same changes as RoleService:

```python
from ..services.authorization_mixin import ApplicationContextMixin

class PermissionService(ApplicationContextMixin):
    # Remove _get_app_context_service and _get_environment_from_context methods
    # Keep all other methods unchanged
```

## File Size Analysis

Current file sizes:
- `role.py`: 366 lines
- `permission.py`: 372 lines

After removing 26 lines of duplicated code from each:
- `role.py`: ~340 lines
- `permission.py`: ~346 lines

New file:
- `authorization_mixin.py`: ~50 lines

## Definition of Done

1. Create `authorization_mixin.py` with shared methods
2. Update `RoleService` to use mixin
3. Update `PermissionService` to use mixin
4. Run `ruff check` - 0 errors
5. Run `pytest tests/unit/` - all tests pass
6. No regression in functionality

## Benefits

- Eliminates 26 lines of duplicated code per service
- Single source of truth for application context logic
- Easier maintenance - changes only need to be made in one place
- Follows DRY principle (Don't Repeat Yourself)

---

## Validation

**Date**: 2026-01-26

**Status**: COMPLETE

### Executive Summary

Successfully extracted duplicated application context methods from RoleService and PermissionService into a shared ApplicationContextMixin class.

### File Changes

| File | Before | After | Change |
|------|--------|-------|--------|
| `miso_client/services/role.py` | 366 lines | 341 lines | -25 lines |
| `miso_client/services/permission.py` | 372 lines | 347 lines | -25 lines |
| `miso_client/services/authorization_mixin.py` | NEW | 53 lines | +53 lines |

### Code Quality Validation

**STEP 1 - LINT**: PASSED
- `ruff check`: 0 errors, 0 warnings

**STEP 2 - TEST**: PASSED
- All 1234 tests pass
- Coverage: 92%

### Final Checklist

- [x] ApplicationContextMixin created with shared methods
- [x] RoleService updated to use mixin
- [x] PermissionService updated to use mixin
- [x] All tests pass
- [x] Linting passes
- [x] Code duplication eliminated

**Result**: VALIDATION PASSED - Code duplication eliminated successfully.
